---
import MobileLayout from '../layouts/MobileLayout.astro';
---
<MobileLayout>
  <div class="page-wrapper">
    
    <header class="mobile-header theme-dark" transition:persist>
      <a href="/" class="mobile-header-logo" transition:name="logo-gba">GBA</a>
      <div class="mobile-header-right">
        <a href="/personale" aria-label="Torna alla collezione">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none">
               <path d="M19 12H5M12 19l-7-7 7-7" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
        </a>
      </div>
    </header>

    <div class="corner-plus top-left-plus">+</div>
    <div class="corner-plus top-right-plus">+</div>
    <div class="corner-plus bottom-left-plus">+</div>
    <div class="corner-plus bottom-right-plus">+</div>

    <main class="content-area">
        <div id="card-to-download" class="wrapped-card">
            
            <div class="image-slider-wrapper">
                    <div class="image-slide"><img src="/MACRO12.jpg" alt="aechmea" class="featured-image"/></div>
                <div class="image-slide"><img src="/MACRO71.jpg" alt="Papiro Egiziano" class="featured-image"/></div>
                <div class="image-slide"><img src="/MACRO79.jpg" alt="Albero Rigoglioso" class="featured-image"/></div>
                <div class="image-slide"><img src="/MACRO196.jpg" alt="Pianta Grassa" class="featured-image"/></div>
                <div class="image-slide"><img src="/MACRO258.jpg" alt="Description for image 5" class="featured-image"/></div>
                <div class="image-slide"><img src="/MACRO245.jpg" alt="Description for image 6" class="featured-image"/></div>
                <div class="image-slide"><img src="/MACRO292.jpg" alt="Description for image 7" class="featured-image"/></div>
                <div class="image-slide"><img src="/MACRO376.jpg" alt="Description for image 8" class="featured-image"/></div>
                <div class="image-slide"><img src="/papiro-egiziano.jpg" alt="Description for image 9" class="featured-image"/></div>
                 <div class="image-slide"><img src="/MACRO484.jpg" alt="Description for image 10" class="featured-image"/></div>
            </div>
            </div>
            
            <div class="overlay-text overlay-top-left">
                Orto Botanico<br>
                Urbino, Italy
            </div>
            <div class="overlay-text overlay-top-right">
                25 • 10 • 2025<br>
                18°C
            </div>
            <div class="overlay-text overlay-bottom-center">
                You saw <span class="highlight">10 plants</span>
            </div>
        </div>
    </main>

    <a id="open-share-overlay" class="share-link">SHARE</a>

    <div id="share-overlay" class="share-overlay">
        <div class="share-backdrop"></div>
        <div class="share-sheet">
            <button id="close-share-overlay" class="close-share-btn">
                <svg width="24" height="24" viewBox="0 0 24 24"><path d="M18 6L6 18M6 6L18 18" stroke="#333" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
            </button>
            <div class="share-header-action"><h2 class="share-title">Share with friends</h2></div>
            <p class="share-to-label">Share to</p>
            <div class="social-icons">
                <a href="mailto:?subject=My%20Visit%20to%20Urbino's%20Botanical%20Garden&body=I%20had%20so%20much%20fun%20at%20the%20Urbino's%20Botanical%20Garden!%0A%0A(Don't%20forget%20to%20attach%20the%20image!)" class="social-item-link"><div class="social-item"><img src="/icons/mail.svg" alt="Mail" class="social-icon mail-icon"><span>Mail</span></div></a>
                <div class="social-item"><img src="/icons/instagram.svg" alt="Instagram" class="social-icon"><span>Instagram</span></div>
                <div class="social-item"><img src="/icons/whatsapp.svg" alt="Whatsapp" class="social-icon"><span>Whatsapp</span></div>
                <button id="save-card-btn" class="social-item-button"><div class="social-item"><img src="/icons/save.svg" alt="Save Image" class="social-icon save-icon"><span>Save</span></div></button>
            </div>
        </div>
    </div>
  </div>
</MobileLayout>

<script>
    import html2canvas from 'html2canvas';

    document.addEventListener('astro:page-load', () => {
        const openShareButton = document.getElementById('open-share-overlay');
        const closeShareButton = document.getElementById('close-share-overlay');
        const shareOverlay = document.getElementById('share-overlay');
        const backdrop = shareOverlay ? shareOverlay.querySelector('.share-backdrop') : null;
        const saveCardButton = document.getElementById('save-card-btn');
        const cardToDownload = document.getElementById('card-to-download');
        const imageWrapper = cardToDownload ? cardToDownload.querySelector('.image-slider-wrapper') : null;
        const imageSlides = cardToDownload ? cardToDownload.querySelectorAll('.image-slide') : null;

        if (!openShareButton || !closeShareButton || !shareOverlay || !backdrop || !saveCardButton || !cardToDownload || !imageWrapper || !imageSlides || imageSlides.length === 0) { 
            console.error("Wrapped Page: Required elements not found!"); 
            return; 
        }

        const imageCount = imageSlides.length;

        function openOverlay() { shareOverlay.classList.add('is-visible'); }
        function closeOverlay() { shareOverlay.classList.remove('is-visible'); }
        openShareButton.addEventListener('click', openOverlay);
        closeShareButton.addEventListener('click', closeOverlay);
        backdrop.addEventListener('click', closeOverlay);

        let currentImageIndex = 0, startX = 0, currentTranslate = 0, previousTranslate = 0, isDragging = false, cardWidth = cardToDownload.offsetWidth;

         const resizeObserver = new ResizeObserver(entries => {
            for (let entry of entries) {
                 if (entry.target === cardToDownload) {
                     cardWidth = entry.contentRect.width;
                     const targetTranslate = -currentImageIndex * cardWidth;
                     imageWrapper.style.transition = 'none';
                     imageWrapper.style.transform = `translateX(${targetTranslate}px)`;
                     previousTranslate = targetTranslate;
                     currentTranslate = targetTranslate;
                     setTimeout(() => { imageWrapper.style.transition = 'transform 0.3s ease-out'; }, 50);
                 }
            }
         });
         resizeObserver.observe(cardToDownload);

        function setSliderPosition() { imageWrapper.style.transform = `translateX(${currentTranslate}px)`; }
        function snapToSlide() {
            const targetTranslate = -currentImageIndex * cardWidth;
            imageWrapper.style.transition = 'transform 0.3s ease-out';
            imageWrapper.style.transform = `translateX(${targetTranslate}px)`;
            previousTranslate = targetTranslate;
            currentTranslate = targetTranslate;
        }
        function handleDragStart(clientX) { isDragging = true; startX = clientX; previousTranslate = -currentImageIndex * cardWidth; imageWrapper.style.transition = 'none'; cardToDownload.style.cursor = 'grabbing'; }
        function handleDragMove(clientX) { if (!isDragging) return; const diffX = clientX - startX; currentTranslate = previousTranslate + diffX; setSliderPosition(); }
        function handleDragEnd() {
            if (!isDragging) return; isDragging = false; cardToDownload.style.cursor = 'grab';
            const movedBy = currentTranslate - previousTranslate; const threshold = cardWidth / 4;
            if (movedBy < -threshold && currentImageIndex < imageCount - 1) { currentImageIndex++; }
            else if (movedBy > threshold && currentImageIndex > 0) { currentImageIndex--; }
            snapToSlide();
        }

        cardToDownload.addEventListener('touchstart', (e) => handleDragStart(e.touches[0].clientX), { passive: true });
        cardToDownload.addEventListener('touchmove', (e) => handleDragMove(e.touches[0].clientX), { passive: true });
        cardToDownload.addEventListener('touchend', handleDragEnd);
        cardToDownload.addEventListener('mousedown', (e) => handleDragStart(e.clientX));
        cardToDownload.addEventListener('mousemove', (e) => { if (isDragging) e.preventDefault(); handleDragMove(e.clientX) });
        cardToDownload.addEventListener('mouseup', handleDragEnd);
        cardToDownload.addEventListener('mouseleave', () => { if (isDragging) handleDragEnd(); });

        snapToSlide(); setTimeout(() => { imageWrapper.style.transition = 'transform 0.3s ease-out'; }, 50); cardToDownload.style.cursor = 'grab';

        function downloadCardImage() {
            if (!html2canvas) { console.error("html2canvas library is not loaded!"); return; }
            const scale = window.devicePixelRatio * 2;
            html2canvas(cardToDownload, { allowTaint: true, useCORS: true, backgroundColor: null, scale: scale, width: cardToDownload.offsetWidth, height: cardToDownload.offsetHeight })
            .then(canvas => {
                const imageURL = canvas.toDataURL("image/jpg"); const downloadLink = document.createElement('a'); downloadLink.href = imageURL; downloadLink.download = `urbino-botanic-wrapped-img${currentImageIndex+1}.jpg`;
                document.body.appendChild(downloadLink); downloadLink.click(); document.body.removeChild(downloadLink);
            }).catch(error => { console.error("Error capturing card with html2canvas:", error); });
        }
        if(saveCardButton) saveCardButton.addEventListener('click', downloadCardImage);
    });
</script>

<style>
    /* --- CSS HEADER --- */
    .mobile-header {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      z-index: 100;
      display: flex;
      justify-content: space-between;
      align-items: center;
      /* --- VERIFICATO: Padding identico a personale.astro --- */
      padding: 1rem 0.5rem; 
      box-sizing: border-box;
      transition: background-color 0.3s ease;
      /* Il border-bottom è gestito dalle classi .theme-light/.theme-dark */
    }

    .mobile-header-logo {
      font-family: 'Monument Grotesk Trial', sans-serif;
      font-size: 1.1rem;
      font-weight: 700;
      text-decoration: none;
      z-index: 1;
    }

    .mobile-header-right {
      font-family: 'Monument Grotesk Mono Trial', monospace;
      font-size: 0.9rem;
      font-weight: 500;
      text-transform: uppercase;
      text-align: right;
      z-index: 1;
      display: flex;
      gap: 0.8rem;
    }

    .mobile-header-right a,
    .mobile-header-right span {
      text-decoration: none;
    }
    
    .mobile-header.theme-light {
      background-color: #ffffff;
      color: #000000;
      border-bottom: 1px solid #eee;
    }
    .mobile-header.theme-light .mobile-header-logo,
    .mobile-header.theme-light .mobile-header-right a,
    .mobile-header.theme-light .mobile-header-right span {
      color: #000;
    }

    .mobile-header.theme-dark {
      background-color: #000000; 
      color: #ffffff;
      /* --- CORRETTO: Rimosso il border-bottom da qui --- */
      /* border-bottom: 1px solid #333; */ 
    }
    .mobile-header.theme-dark .mobile-header-logo,
    .mobile-header.theme-dark .mobile-header-right a,
    .mobile-header.theme-dark .mobile-header-right span {
      color: #fff;
    }
    .mobile-header.theme-dark .mobile-header-right svg path {
      stroke: #fff;
    }
    /* --- FINE CSS HEADER --- */


    /* --- LAYOUT PAGINA --- */
    .page-wrapper {
        position: relative;
        width: 100%;
        height: 100vh;
        background: #000;
        
        color: white;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        overflow: hidden;
    }
    
    .corner-plus {
        position: absolute;
        color: white;
        font-size: 2rem;
        font-weight: 5;
        z-index: 5;
    }
    
    .top-left-plus { 
        top: 4.5rem; 
        left: 4.5rem; 
        transform: translate(-50%, -50%);
    }
    .top-right-plus { 
        top: 4.5rem; 
        right: 4.5rem; 
        transform: translate(50%, -50%);
    }
    .bottom-left-plus { 
        bottom: 4.5rem; 
        left: 4.5rem; 
        transform: translate(-50%, 50%);
    }
    .bottom-right-plus { 
        bottom: 4.5rem; 
        right: 4.5rem; 
        transform: translate(50%, 50%);
    }


    .content-area {
        position: absolute;
        top: 4.5rem; 
        bottom: 4.5rem;
        left: 4.5rem;
        right: 4.5rem;
    }


    .share-link {
        position: absolute;
        bottom: 2.5rem;
        right: 1.5rem;
        z-index: 10;
        font-family: monospace;
        color: white;
        text-decoration: none;
        font-weight: 600;
        font-size: 0.9rem;
        text-transform: uppercase;
        cursor: pointer;
    }

    .wrapped-card {
        background-color: #000000; 
        border-radius: 0;
        width: 100%;
        height: 100%;
        overflow: hidden; 
        position: relative;
        display: flex;
        cursor: grab;
    }
    .wrapped-card:active { cursor: grabbing; }

    .image-overlay-wrapper { width: 100%; height: 100%; position: relative; overflow: hidden; }
    .image-slider-wrapper { display: flex; height: 100%; }
    .image-slide { width: 100%; height: 100%; flex-shrink: 0; }
    .featured-image { display: block; width: 100%; height: 100%; object-fit: cover; user-select: none; -webkit-user-drag: none; }

     .overlay-text {
        position: absolute; 
        
        color: white; 
        padding: 1.5rem;
        font-size: 0.8rem;
        line-height: 1;
        pointer-events: none; 
        user-select: none;
        font-weight: 500;
        
    }
    .overlay-top-left {
        top: 0; left: 0; text-align: left;
        transform: translateY(200px);
    }
    .overlay-top-right {
        top: 0; right: 0; text-align: right;
        transform: translateY(200px);
    }
    .overlay-bottom-center {
        bottom: 0; left: 0; right: 0; text-align: center;
        padding-bottom: 1.5rem; 
        font-size: 1.3rem;
        font-weight: 500;
    }
    .overlay-bottom-center .highlight { font-weight: bold; }

    /* Overlay Condivisione */
   /* --- MODIFICHE OVERLAY CONDIVISIONE (Nero/Bianco) --- */
    .share-overlay { 
        position: fixed; 
        inset: 0; 
        z-index: 1000; 
        display: flex; 
        justify-content: center; 
        align-items: flex-end; 
        opacity: 0; 
        visibility: hidden; 
        pointer-events: none; 
        transition: opacity 0.3s ease, visibility 0s linear 0.3s; 
    }
    .share-overlay.is-visible { 
        opacity: 1; 
        visibility: visible; 
        pointer-events: auto; 
        transition: opacity 0.3s ease, visibility 0s linear 0s; 
    }
    .share-backdrop { 
        position: absolute; 
        inset: 0; 
        background-color: rgba(0, 0, 0, 0.5); /* Sfondo semi-trasparente nero */
    }
    .share-sheet { 
        width: 100%; 
        background-color: #000000; /* Sfondo nero */
        color: #ffffff; /* Testo bianco */
        border-radius: 25px 25px 0 0; 
        padding: 1.5rem; 
        box-sizing: border-box; 
        transform: translateY(100%); 
        transition: transform 0.4s cubic-bezier(0.25, 0.8, 0.25, 1); 
        padding-bottom: 3rem; 
        position: relative; 
        z-index: 1; 
        /* Rimosso backdrop-filter */
    }
    .share-overlay.is-visible .share-sheet { 
        transform: translateY(0); 
    }
    .close-share-btn { 
      position: absolute; 
        top: 1rem; 
        right: 1rem; 
        /* --- MODIFICHE --- */
        background-color: transparent; /* Rimosso sfondo */
        border: none; 
        border-radius: 0; /* Rimosso arrotondamento */
        width: auto; /* Dimensione automatica basata su SVG */
        height: auto; /* Dimensione automatica basata su SVG */
        padding: 0; /* Rimosso padding interno se presente */
        /* --- FINE MODIFICHE --- */
        display: flex; /* Mantenuto per allineare SVG */
        justify-content: center; 
        align-items: center; 
        cursor: pointer; 
        z-index: 10; 
    }
    .close-share-btn svg path { 
        stroke: #ffffff; /* Mantenuto: Icona 'X' bianca */
    }
    .share-header-action { 
        margin-bottom: 2rem; 
        margin-top: 1rem; 
    }
    .share-title { 
        font-size: 1rem; 
        font-family: Arial, Helvetica, sans-serif;
        font-weight: 700; 
        line-height: 1.1; 
        margin: 0; 
        text-transform: uppercase;
        text-align: left; 
        color: #ffffff; /* Titolo bianco */
    }
    .share-to-label { 
        text-align: left; 
        color: #888; /* Testo "Share to" grigio chiaro */
        font-size: 0.9rem; 
         font-family: Arial, Helvetica, sans-serif;
        margin-top: 0.5rem;
        margin-bottom: 1.5rem; 
    }
    .social-icons { 
        display: flex; 
        justify-content: space-between; 
        gap: 1rem; 
        flex-wrap: wrap; 
        padding: 0 0.5rem; 
    }
    .social-item-link { 
        text-decoration: none; 
       
    }
    .social-item-button { 
        background: none; 
        border: none; 
        padding: 0; 
        cursor: pointer; 
        text-align: inherit; 
        
        font: inherit; 
    }
    .social-item { 
        display: flex; 
        flex-direction: column; 
        align-items: center; 
        color: #ffffff; /* Testo icone bianco */
        font-size: 0.75rem; 
        text-align: center; 
        gap: 0.5rem; 
         font-family: Arial, Helvetica, sans-serif;
    }
    .social-icon { 
        width: 50px; 
        height: 50px; 
        border-radius: 12px; 
        padding: 8px; 
        box-sizing: border-box; 
        transition: transform 0.2s ease; 
        /* Rimosso background specifico per icona */
        background-color: #222; /* Sfondo icone grigio scuro */
    }
    .social-icon:hover { 
        transform: scale(1.05); 
    }
    /* Rimosse le regole specifiche per .mail-icon, nth-child(2), nth-child(3), .save-icon */
    /* Assicurati che le tue SVG siano bianche o usa CSS per cambiarne il colore se possibile */
</style>