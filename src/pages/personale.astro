---
import MobileLayout from '../layouts/MobileLayout.astro';
import ScanCard from '../components/ScanCard.astro'; 

const staticPlants = [
  "Aechmea gamosepala",
  "Bosso",
  "Cactus a Coda di Scimmia",
  "Edera",
  "Gaillardia",
  "Gigaro scuro",
  "Kratom",
  "Orchidea Phalaenopsis"
];
---
<MobileLayout>
  <div class="page-wrapper">
    
    <header class="mobile-header theme-dark" transition:persist>
      <a href="/" class="mobile-header-logo" transition:name="logo-gba">GBA</a>
      <div class="mobile-header-right">
        <a href="/personale" id="collection-header-link">YOUR COLLECTION</a>
      </div>
    </header>

    <div class="content-area">

      <div class="empty-message">
        <h2>HELLO LUCA</h2>
        <p>Scan some plants and add them to your collection</p>
      </div>

      <div id="collection-list" class="collection-list">
        </div>

      <footer class="page-footer">
        <div class="footer-group bottom-left">
         <a href="/wrapped" class="footer-link">SHARE COLLECTION</a>
          <a href="/scanner" class="footer-link">PLANTS SCANNER</a>
        </div>
        <div class="footer-group bottom-right">
          <a href="/locations" class="footer-link">YOUR LOCATION</a>
          <label for="photo-upload-input" class="footer-link">UPDATE PHOTO</label>
        </div>
      </footer>

    </div> <input type="file" id="photo-upload-input" accept="image/*" style="display: none;">

    <div id="fullscreen-image-wrapper" class="fullscreen-wrapper">
        <img id="uploaded-image-preview" src="" alt="Foto caricata">
        <button id="back-to-personale" class="fullscreen-btn back-btn"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none">
                 <path d="M19 12H5M12 19l-7-7 7-7" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
             </svg></button>
        <button id="trigger-scan" class="fullscreen-btn scan-btn">SCAN</button>
    </div>

    <ScanCard />

  </div>
</MobileLayout>

<script define:vars={{ staticPlants }}>
    const COLLECTION_KEY = 'gba_collection';

    function getCollection() {
        const data = sessionStorage.getItem(COLLECTION_KEY);
        return data ? JSON.parse(data) : [];
    }

    // !!! --- MODIFICA QUI --- !!!
    // Sostituito 'DOMContentLoaded' con 'astro:page-load'
    document.addEventListener('astro:page-load', () => {
        const dynamicCollection = getCollection();
        const staticCollection = staticPlants; 
        const fullListToDisplay = [...staticCollection, ...dynamicCollection];
        const collectionCount = dynamicCollection.length;
        const listContainer = document.getElementById('collection-list');
        const emptyMessage = document.querySelector('.empty-message');
        
        const collectionCountHeader = document.getElementById('collection-header-link');

        if (collectionCountHeader) {
          collectionCountHeader.textContent = `YOUR COLLECTION`;
        }
        
        // Controlli per assicurarsi che gli elementi esistano
        if (emptyMessage) emptyMessage.style.display = 'block'; 
        if (listContainer) {
            listContainer.style.display = 'block';
            listContainer.innerHTML = ''; // Pulisci la lista prima di riempirla

            fullListToDisplay.forEach(plantName => {
                const itemWrapper = document.createElement('div');
                itemWrapper.className = 'location-item'; 
                const detailsDiv = document.createElement('div');
                detailsDiv.className = 'item-details'; 
                const plantElement = document.createElement('h2');
                plantElement.className = 'item-name';
                plantElement.textContent = plantName;
                detailsDiv.appendChild(plantElement);
                itemWrapper.appendChild(detailsDiv);
                listContainer.appendChild(itemWrapper);
            });
        }
        
        const uploadInput = document.getElementById('photo-upload-input');
        const fullscreenWrapper = document.getElementById('fullscreen-image-wrapper');
        const imagePreview = document.getElementById('uploaded-image-preview');
        const backButton = document.getElementById('back-to-personale');
        const scanButton = document.getElementById('trigger-scan');
        const pageWrapper = document.querySelector('.page-wrapper');
        const scanCardOverlay = document.getElementById('scan-card-overlay');
        const closeScanCardButton = document.getElementById('close-scan-card');
        const scanCardBackdrop = scanCardOverlay ? scanCardOverlay.querySelector('.scan-card-backdrop') : null;

        if (uploadInput) {
            uploadInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    if (imagePreview) imagePreview.src = e.target.result;
                    if (fullscreenWrapper) fullscreenWrapper.classList.add('is-visible');
                    if (pageWrapper) pageWrapper.style.overflow = 'hidden'; 
                };
                reader.readAsDataURL(file);
            });
        }

        if (backButton) {
            backButton.addEventListener('click', () => {
                if (fullscreenWrapper) fullscreenWrapper.classList.remove('is-visible');
                if(uploadInput) uploadInput.value = null;
                if (imagePreview) imagePreview.src = "";
                if (pageWrapper) pageWrapper.style.overflow = 'auto'; 
            });
        }

        if (scanButton) {
            scanButton.addEventListener('click', () => {
                if (scanCardOverlay) {
                    scanCardOverlay.classList.add('is-visible');
                }
            });
        }

        function closeScanOverlay() {
            if (scanCardOverlay) {
                scanCardOverlay.classList.remove('is-visible');
            }
        }

        if (closeScanCardButton) {
            closeScanCardButton.addEventListener('click', closeScanOverlay);
        }
        if (scanCardBackdrop) {
            scanCardBackdrop.addEventListener('click', closeScanOverlay);
        }
    });
</script>

<style>
  /* --- CSS HEADER --- */
  .mobile-header {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    z-index: 100;
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem 0.5rem; 
    box-sizing: border-box;
    transition: background-color 0.3s ease;
  }

  .mobile-header-logo {
    font-family: 'Monument Grotesk Trial', sans-serif;
    font-size: 1.1rem;
    font-weight: 700;
    text-decoration: none;
    z-index: 1;
  }

  .mobile-header-right {
    font-family: 'Monument Grotesk Mono Trial', monospace;
    font-size: 0.9rem;
    font-weight: 500;
    text-transform: uppercase;
    text-align: right;
    z-index: 1;
    display: flex;
    gap: 0.8rem;
  }

  .mobile-header-right a,
  .mobile-header-right span {
    text-decoration: none;
  }
  
  .mobile-header.theme-light {
    background-color: #ffffff;
    color: #000000;
  }
  .mobile-header.theme-light .mobile-header-logo,
  .mobile-header.theme-light .mobile-header-right a,
  .mobile-header.theme-light .mobile-header-right span {
    color: #000;
  }

  .mobile-header.theme-dark {
    background-color: #000000; 
    color: #ffffff;
  }
  .mobile-header.theme-dark .mobile-header-logo,
  .mobile-header.theme-dark .mobile-header-right a,
  .mobile-header.theme-dark .mobile-header-right span {
    color: #fff;
  }
  .mobile-header.theme-dark .mobile-header-right svg path {
    stroke: #fff;
  }
  /* --- FINE CSS HEADER --- */


  .page-wrapper {
    position: relative;
    width: 100%;
   min-height: 100%;
    overflow: auto;
    background-color: #ffffff;
    color: #333; 
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
  }

  .content-area {
    padding: 8rem 0 4rem 0; 
  }

  .empty-message,
  .page-footer {
    padding-left: 1.5rem;
    padding-right: 1.5rem;
  }

  .empty-message h2 {
    font-size: 1.5rem;
    margin: 0 0 0.5rem 0;
    color: #000;
  }
  .empty-message p {
    font-size: 1rem;
    color: #757575;
    margin: 0;
    max-width: 250px;
    line-height: 1.4;
  }
  
  .page-footer {
    margin-top: 3rem; 
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
  }
  .footer-group {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }
  .bottom-left {
    align-items: flex-start;
  }
  .bottom-right {
    align-items: flex-end;
  }
  .footer-link,
  .footer-link:visited {
    text-decoration: none;
    color: #000000;
    font-weight: 600;
    font-size: 0.9rem;
    text-transform: uppercase;
    cursor: pointer;
    position: static;
  }

  .collection-list {
    display: none; 
    margin-top: 2rem;
  }

  .location-item {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    padding: 1.5rem;
    border-bottom: 1px solid #eee;
    text-decoration: none;
    color: inherit;
  }
  
  .location-item:first-child {
      border-top: 1px solid #eee;
  }

  .item-details {
    display: flex;
    flex-direction: column;
  }
  .item-name {
    font-size: 1.5rem; 
    font-weight: 600;
    margin: 0 0 0.25rem 0;
    color: #000;
  }

  /* Stili upload e preview */
  .fullscreen-wrapper {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100dvh;
      z-index: 1000;
      background: #000;
      display: none;
  }
  .fullscreen-wrapper.is-visible {
      display: block;
  }
  
  #uploaded-image-preview {
      width: 100%;
      height: 100%;
      object-fit: contain;
  }
 .fullscreen-btn {
      position: absolute;
      z-index: 1010;
      padding: 10px 15px; /* Keep some padding for easier clicking */
      cursor: pointer;
      font-size: 0.9rem;
      text-transform: uppercase;
      font-weight: 600; /* Keep weight */
      background: none; /* Remove common background */
      border: none; /* Remove common border */
      color: white; /* Default color white */
       /* Remove properties moved to specific buttons or no longer needed */
       /* backdrop-filter: blur(10px); */
       /* border-radius: 8px; */
  }
  .back-btn {
      top: 2.5rem;
      left: 1.5rem;
       /* Removed background, border etc. inherited from .fullscreen-btn */
  }
   /* Style the SVG inside the back button */
   .back-btn svg {
       display: block; /* Prevents extra space */
       width: 24px;   /* Match SVG dimensions */
       height: 24px;
   }
   .back-btn svg path {
       stroke: white; /* Ensure path is white */
   }
  .scan-btn {
      bottom: 2.5rem;
      right: 1.5rem;
      /* --- MODIFICATIONS --- */
      background: none; /* Explicitly no background */
      border: none; /* Explicitly no border */
      color: white;
      font-family: 'Monument Grotesk Mono Trial', monospace; /* Monospace font */
      font-weight: 500; /* Match other mono text weight */
      /* Remove button-specific styles */
      /* background: white; */
      /* color: #000; */
      /* backdrop-filter: blur(10px); */
      /* border-radius: 8px; */
      /* border: 1px solid rgba(255, 255, 255, 0.4); */
  }
</style>